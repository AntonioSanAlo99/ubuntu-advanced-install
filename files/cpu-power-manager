#!/bin/bash
# CPU Power Manager - Similar a ThrottleStop para Linux
# Gesti√≥n completa de CPU: Undervolt, TDP, PROCHOT, Frecuencias

VERSION="1.0.0"

# Colores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color
BOLD='\033[1m'

# ============================================================================
# L√çMITES DE SEGURIDAD (basados en ThrottleStop)
# ============================================================================

# Undervolt (mV) - Valores NEGATIVOS
readonly UV_MIN=-250      # M√°ximo undervolt permitido
readonly UV_MAX=50        # M√°ximo overvolt permitido (generalmente no recomendado)
readonly UV_SAFE=-125     # L√≠mite "seguro" recomendado

# TDP/Power Limits (Watts)
readonly PL_MIN=5         # M√≠nimo TDP (5W para ultrabooks extremos)
readonly PL_MAX=125       # M√°ximo TDP (125W para desktop replacement)
readonly PL_SAFE_MIN=15   # M√≠nimo recomendado
readonly PL_SAFE_MAX=65   # M√°ximo recomendado para laptops

# Time Window (segundos)
readonly TIME_MIN=1       # M√≠nimo 1 segundo
readonly TIME_MAX=128     # M√°ximo 128 segundos (ThrottleStop limit)
readonly TIME_DEFAULT=28  # Valor por defecto Intel

# PROCHOT Offset (¬∞C)
readonly PROCHOT_MIN=-15  # M√°ximo offset negativo
readonly PROCHOT_MAX=15   # M√°ximo offset positivo

# Frecuencias (MHz)
readonly FREQ_MIN=400     # M√≠nima frecuencia absoluta
readonly FREQ_MAX=6000    # M√°xima frecuencia te√≥rica (futuras CPUs)

# ============================================================================
# FUNCIONES DE VALIDACI√ìN
# ============================================================================

validate_number() {
    local value=$1
    # Verificar que es un n√∫mero (positivo o negativo)
    if ! [[ "$value" =~ ^-?[0-9]+$ ]]; then
        return 1
    fi
    return 0
}

validate_undervolt() {
    local value=$1
    local component=$2
    
    if ! validate_number "$value"; then
        echo -e "${RED}‚úó Error: Debe ser un n√∫mero${NC}"
        return 1
    fi
    
    if [ $value -lt $UV_MIN ]; then
        echo -e "${RED}‚úó Error: Undervolt demasiado alto (l√≠mite: ${UV_MIN}mV)${NC}"
        echo -e "${YELLOW}  Valores menores a ${UV_MIN}mV son peligrosos${NC}"
        return 1
    fi
    
    if [ $value -gt $UV_MAX ]; then
        echo -e "${RED}‚úó Error: Overvolt no recomendado (l√≠mite: ${UV_MAX}mV)${NC}"
        echo -e "${YELLOW}  Valores positivos pueden da√±ar el CPU${NC}"
        return 1
    fi
    
    # Advertencia si est√° fuera del rango seguro
    if [ $value -lt $UV_SAFE ] && [ $value -ge $UV_MIN ]; then
        echo -e "${YELLOW}‚ö† Advertencia: Undervolt muy agresivo ($value mV)${NC}"
        echo -e "${YELLOW}  Rango seguro: 0 a ${UV_SAFE}mV${NC}"
        read -p "  ¬øContinuar de todos modos? (s/n): " confirm
        if [ "$confirm" != "s" ] && [ "$confirm" != "S" ]; then
            return 1
        fi
    fi
    
    return 0
}

validate_power_limit() {
    local value=$1
    local type=$2  # PL1 o PL2
    
    if ! validate_number "$value"; then
        echo -e "${RED}‚úó Error: Debe ser un n√∫mero${NC}"
        return 1
    fi
    
    if [ $value -lt $PL_MIN ]; then
        echo -e "${RED}‚úó Error: TDP demasiado bajo (m√≠nimo: ${PL_MIN}W)${NC}"
        return 1
    fi
    
    if [ $value -gt $PL_MAX ]; then
        echo -e "${RED}‚úó Error: TDP demasiado alto (m√°ximo: ${PL_MAX}W)${NC}"
        echo -e "${YELLOW}  Valores sobre ${PL_MAX}W pueden da√±ar el hardware${NC}"
        return 1
    fi
    
    # Advertencia si est√° fuera del rango seguro
    if [ $value -lt $PL_SAFE_MIN ] || [ $value -gt $PL_SAFE_MAX ]; then
        echo -e "${YELLOW}‚ö† Advertencia: TDP fuera del rango t√≠pico de laptops${NC}"
        echo -e "${YELLOW}  Rango recomendado: ${PL_SAFE_MIN}W - ${PL_SAFE_MAX}W${NC}"
        read -p "  ¬øContinuar de todos modos? (s/n): " confirm
        if [ "$confirm" != "s" ] && [ "$confirm" != "S" ]; then
            return 1
        fi
    fi
    
    return 0
}

validate_time_window() {
    local value=$1
    
    if ! validate_number "$value"; then
        echo -e "${RED}‚úó Error: Debe ser un n√∫mero${NC}"
        return 1
    fi
    
    if [ $value -lt $TIME_MIN ]; then
        echo -e "${RED}‚úó Error: Tiempo muy corto (m√≠nimo: ${TIME_MIN}s)${NC}"
        return 1
    fi
    
    if [ $value -gt $TIME_MAX ]; then
        echo -e "${RED}‚úó Error: Tiempo muy largo (m√°ximo: ${TIME_MAX}s)${NC}"
        return 1
    fi
    
    return 0
}

validate_prochot() {
    local value=$1
    
    if ! validate_number "$value"; then
        echo -e "${RED}‚úó Error: Debe ser un n√∫mero${NC}"
        return 1
    fi
    
    if [ $value -lt $PROCHOT_MIN ] || [ $value -gt $PROCHOT_MAX ]; then
        echo -e "${RED}‚úó Error: PROCHOT offset fuera de rango${NC}"
        echo -e "${YELLOW}  Rango permitido: ${PROCHOT_MIN}¬∞C a ${PROCHOT_MAX}¬∞C${NC}"
        return 1
    fi
    
    if [ $value -ne 0 ]; then
        echo -e "${YELLOW}‚ö† PROCHOT offset es una caracter√≠stica avanzada${NC}"
        echo -e "${YELLOW}  Puede causar throttling incorrecto${NC}"
        read -p "  ¬øContinuar? (s/n): " confirm
        if [ "$confirm" != "s" ] && [ "$confirm" != "S" ]; then
            return 1
        fi
    fi
    
    return 0
}

validate_frequency() {
    local value=$1
    local type=$2  # min o max
    
    if ! validate_number "$value"; then
        echo -e "${RED}‚úó Error: Debe ser un n√∫mero${NC}"
        return 1
    fi
    
    if [ $value -lt $FREQ_MIN ]; then
        echo -e "${RED}‚úó Error: Frecuencia muy baja (m√≠nimo: ${FREQ_MIN}MHz)${NC}"
        return 1
    fi
    
    if [ $value -gt $FREQ_MAX ]; then
        echo -e "${RED}‚úó Error: Frecuencia muy alta (m√°ximo: ${FREQ_MAX}MHz)${NC}"
        return 1
    fi
    
    # Verificar que no exceda el m√°ximo del hardware
    if [ $value -gt $CPUINFO_MAX ]; then
        echo -e "${YELLOW}‚ö† Advertencia: Frecuencia mayor al m√°ximo del hardware${NC}"
        echo -e "${YELLOW}  M√°ximo HW: ${CPUINFO_MAX}MHz, solicitado: ${value}MHz${NC}"
        echo -e "${YELLOW}  Se limitar√° autom√°ticamente a ${CPUINFO_MAX}MHz${NC}"
        # Ajustar al m√°ximo del hardware
        if [ "$type" = "max" ]; then
            echo $CPUINFO_MAX
            return 2  # C√≥digo especial: ajustado
        fi
    fi
    
    return 0
}

validate_frequency_range() {
    local min_freq=$1
    local max_freq=$2
    
    if [ $min_freq -gt $max_freq ]; then
        echo -e "${RED}‚úó Error: Frecuencia m√≠nima no puede ser mayor que la m√°xima${NC}"
        echo -e "  M√≠nima: ${min_freq}MHz, M√°xima: ${max_freq}MHz"
        return 1
    fi
    
    if [ $((max_freq - min_freq)) -lt 100 ]; then
        echo -e "${YELLOW}‚ö† Advertencia: Rango de frecuencias muy estrecho${NC}"
        echo -e "${YELLOW}  Puede limitar el rendimiento${NC}"
    fi
    
    return 0
}

# ============================================================================
# FUNCI√ìN PARA MOSTRAR L√çMITES
# ============================================================================

show_limits() {
    echo -e "${BOLD}${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "${BOLD}${CYAN}                    L√çMITES DE SEGURIDAD${NC}"
    echo -e "${BOLD}${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo ""
    
    echo -e "${BOLD}${YELLOW}Undervolt (mV):${NC}"
    echo -e "  M√≠nimo permitido:  ${RED}${UV_MIN}${NC} mV (muy peligroso)"
    echo -e "  L√≠mite seguro:     ${GREEN}${UV_SAFE}${NC} mV"
    echo -e "  Sin undervolt:     ${GREEN}0${NC} mV"
    echo -e "  M√°ximo permitido:  ${RED}${UV_MAX}${NC} mV (overvolt no recomendado)"
    echo ""
    
    echo -e "${BOLD}${YELLOW}TDP / Power Limits (W):${NC}"
    echo -e "  M√≠nimo absoluto:   ${RED}${PL_MIN}${NC} W"
    echo -e "  Rango seguro:      ${GREEN}${PL_SAFE_MIN}${NC} - ${GREEN}${PL_SAFE_MAX}${NC} W"
    echo -e "  M√°ximo permitido:  ${RED}${PL_MAX}${NC} W (desktop replacement)"
    echo ""
    
    echo -e "${BOLD}${YELLOW}Time Window (s):${NC}"
    echo -e "  M√≠nimo:            ${GREEN}${TIME_MIN}${NC} s"
    echo -e "  Por defecto:       ${GREEN}${TIME_DEFAULT}${NC} s"
    echo -e "  M√°ximo:            ${GREEN}${TIME_MAX}${NC} s"
    echo ""
    
    echo -e "${BOLD}${YELLOW}PROCHOT Offset (¬∞C):${NC}"
    echo -e "  Rango permitido:   ${GREEN}${PROCHOT_MIN}${NC} a ${GREEN}${PROCHOT_MAX}${NC} ¬∞C"
    echo -e "  Recomendado:       ${GREEN}0${NC} ¬∞C (sin offset)"
    echo ""
    
    echo -e "${BOLD}${YELLOW}Frecuencias (MHz):${NC}"
    echo -e "  M√≠nimo absoluto:   ${GREEN}${FREQ_MIN}${NC} MHz"
    echo -e "  M√°ximo te√≥rico:    ${GREEN}${FREQ_MAX}${NC} MHz"
    echo -e "  HW M√°ximo actual:  ${CYAN}${CPUINFO_MAX}${NC} MHz"
    echo ""
    
    echo -e "${BOLD}${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo ""
    echo -e "${YELLOW}Estos l√≠mites est√°n basados en ThrottleStop y especificaciones Intel${NC}"
    echo -e "${YELLOW}para proteger tu hardware de configuraciones peligrosas.${NC}"
    echo ""
    read -p "Presiona Enter para continuar..."
}

# Archivos de configuraci√≥n
CONFIG_DIR="/etc/cpu-power-manager"
UNDERVOLT_CONF="$CONFIG_DIR/undervolt.conf"
POWER_CONF="$CONFIG_DIR/power.conf"
FREQ_CONF="$CONFIG_DIR/frequency.conf"
STARTUP_SCRIPT="/etc/systemd/system/cpu-power-manager.service"

# Estado de cambios sin guardar
UNSAVED_CHANGES=false

# Verificar si se ejecuta como root
if [ "$EUID" -ne 0 ]; then 
    echo -e "${RED}Este programa debe ejecutarse como root${NC}"
    echo "Ejecuta: sudo cpu-power-manager"
    exit 1
fi

# Crear directorios si no existen
mkdir -p "$CONFIG_DIR"

# ============================================================================
# FUNCIONES DE DETECCI√ìN DE HARDWARE
# ============================================================================

detect_cpu() {
    CPU_MODEL=$(grep "model name" /proc/cpuinfo | head -1 | cut -d: -f2 | xargs)
    CPU_CORES=$(nproc)
    
    # Detectar generaci√≥n Intel
    if echo "$CPU_MODEL" | grep -qi "12th Gen\|Alder Lake"; then
        CPU_GEN="12th Gen (Alder Lake)"
        HAS_HYBRID=true
    elif echo "$CPU_MODEL" | grep -qi "13th Gen\|Raptor Lake"; then
        CPU_GEN="13th Gen (Raptor Lake)"
        HAS_HYBRID=true
    elif echo "$CPU_MODEL" | grep -qi "14th Gen"; then
        CPU_GEN="14th Gen"
        HAS_HYBRID=true
    elif echo "$CPU_MODEL" | grep -qi "11th Gen\|Tiger Lake"; then
        CPU_GEN="11th Gen (Tiger Lake)"
        HAS_HYBRID=false
    elif echo "$CPU_MODEL" | grep -qi "10th Gen\|Comet Lake\|Ice Lake"; then
        CPU_GEN="10th Gen"
        HAS_HYBRID=false
    elif echo "$CPU_MODEL" | grep -qi "8th Gen\|9th Gen\|Coffee Lake"; then
        CPU_GEN="8th/9th Gen"
        HAS_HYBRID=false
    else
        CPU_GEN="Unknown"
        HAS_HYBRID=false
    fi
}

detect_cores() {
    # Detectar P-cores y E-cores si existe arquitectura h√≠brida
    if [ "$HAS_HYBRID" = true ]; then
        # En CPUs h√≠bridas, los P-cores tienen mayor capacidad
        # Esta es una aproximaci√≥n - puede necesitar ajuste por modelo
        TOTAL_CORES=$(nproc)
        
        # T√≠picamente en 12th/13th Gen:
        # i9: 8 P-cores + 8-16 E-cores
        # i7: 6 P-cores + 8 E-cores  
        # i5: 6 P-cores + 4-8 E-cores
        
        if [ $TOTAL_CORES -ge 20 ]; then
            P_CORES=8
            E_CORES=$((TOTAL_CORES - P_CORES))
        elif [ $TOTAL_CORES -ge 14 ]; then
            P_CORES=6
            E_CORES=$((TOTAL_CORES - P_CORES))
        else
            P_CORES=4
            E_CORES=$((TOTAL_CORES - P_CORES))
        fi
    else
        P_CORES=$CPU_CORES
        E_CORES=0
    fi
}

# ============================================================================
# FUNCIONES DE LECTURA DE ESTADO
# ============================================================================

read_current_undervolt() {
    if [ -f "$UNDERVOLT_CONF" ]; then
        source "$UNDERVOLT_CONF"
    else
        # Valores por defecto (sin undervolt)
        UV_CPU=0
        UV_GPU=0
        UV_CACHE=0
        UV_SA=0
        UV_IO=0
    fi
}

read_current_power() {
    if [ -f "$POWER_CONF" ]; then
        source "$POWER_CONF"
    else
        # Detectar TDP actual
        if [ -f /sys/class/powercap/intel-rapl/intel-rapl:0/constraint_0_power_limit_uw ]; then
            PL1_CURRENT=$(($(cat /sys/class/powercap/intel-rapl/intel-rapl:0/constraint_0_power_limit_uw) / 1000000))
            PL2_CURRENT=$(($(cat /sys/class/powercap/intel-rapl/intel-rapl:0/constraint_1_power_limit_uw) / 1000000))
            PL1_TIME=$(($(cat /sys/class/powercap/intel-rapl/intel-rapl:0/constraint_0_time_window_us) / 1000000))
        else
            PL1_CURRENT=0
            PL2_CURRENT=0
            PL1_TIME=28
        fi
        
        PROCHOT_OFFSET=0
    fi
}

read_current_freq() {
    # Leer frecuencias actuales
    MIN_FREQ=$(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_min_freq 2>/dev/null || echo "0")
    MAX_FREQ=$(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq 2>/dev/null || echo "0")
    
    # Convertir de KHz a MHz
    MIN_FREQ=$((MIN_FREQ / 1000))
    MAX_FREQ=$((MAX_FREQ / 1000))
    
    # Leer frecuencias m√°ximas del hardware
    CPUINFO_MAX=$(cat /sys/devices/system/cpu/cpu0/cpufreq/cpuinfo_max_freq 2>/dev/null || echo "0")
    CPUINFO_MAX=$((CPUINFO_MAX / 1000))
    
    if [ -f "$FREQ_CONF" ]; then
        source "$FREQ_CONF"
    else
        TARGET_MAX_FREQ=$MAX_FREQ
        TARGET_MIN_FREQ=$MIN_FREQ
        P_CORE_MAX=$MAX_FREQ
        E_CORE_MAX=$MAX_FREQ
    fi
}

read_current_temps() {
    # Leer temperaturas actuales
    if command -v sensors >/dev/null 2>&1; then
        TEMP_OUTPUT=$(sensors 2>/dev/null)
        CPU_TEMP=$(echo "$TEMP_OUTPUT" | grep -i "Package id 0" | grep -o "+[0-9]*" | head -1 | tr -d '+')
        [ -z "$CPU_TEMP" ] && CPU_TEMP=$(echo "$TEMP_OUTPUT" | grep -i "Core 0" | grep -o "+[0-9]*" | head -1 | tr -d '+')
        [ -z "$CPU_TEMP" ] && CPU_TEMP="N/A"
    else
        CPU_TEMP="N/A"
    fi
}

# ============================================================================
# FUNCIONES DE APLICACI√ìN
# ============================================================================

apply_undervolt() {
    if ! command -v intel-undervolt >/dev/null 2>&1; then
        echo -e "${RED}intel-undervolt no est√° instalado${NC}"
        return 1
    fi
    
    # Crear archivo de configuraci√≥n temporal
    cat > /tmp/intel-undervolt.conf << EOF
# Undervolt configuration - Generated by CPU Power Manager
undervolt 0 'CPU' $UV_CPU
undervolt 1 'GPU' $UV_GPU
undervolt 2 'CPU Cache' $UV_CACHE
undervolt 3 'System Agent' $UV_SA
undervolt 4 'Analog I/O' $UV_IO
EOF
    
    # Aplicar INMEDIATAMENTE
    intel-undervolt apply -c /tmp/intel-undervolt.conf 2>/dev/null
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}‚úì Undervolt aplicado AHORA (temporal)${NC}"
        echo -e "${YELLOW}  Los cambios est√°n activos pero NO son persistentes${NC}"
        UNSAVED_CHANGES=true
        return 0
    else
        echo -e "${RED}‚úó Error aplicando undervolt${NC}"
        return 1
    fi
}

apply_power_limits() {
    if [ ! -d /sys/class/powercap/intel-rapl/intel-rapl:0/ ]; then
        echo -e "${RED}RAPL no disponible en este sistema${NC}"
        return 1
    fi
    
    # Aplicar PL1 INMEDIATAMENTE
    if [ $PL1_CURRENT -gt 0 ]; then
        echo $((PL1_CURRENT * 1000000)) > /sys/class/powercap/intel-rapl/intel-rapl:0/constraint_0_power_limit_uw 2>/dev/null
    fi
    
    # Aplicar PL2 INMEDIATAMENTE
    if [ $PL2_CURRENT -gt 0 ]; then
        echo $((PL2_CURRENT * 1000000)) > /sys/class/powercap/intel-rapl/intel-rapl:0/constraint_1_power_limit_uw 2>/dev/null
    fi
    
    # Aplicar ventana de tiempo INMEDIATAMENTE
    echo $((PL1_TIME * 1000000)) > /sys/class/powercap/intel-rapl/intel-rapl:0/constraint_0_time_window_us 2>/dev/null
    
    echo -e "${GREEN}‚úì L√≠mites de potencia aplicados AHORA (temporal)${NC}"
    echo -e "${YELLOW}  Los cambios est√°n activos pero NO son persistentes${NC}"
    UNSAVED_CHANGES=true
}

apply_frequency_limits() {
    # Aplicar frecuencia m√°xima a todos los cores INMEDIATAMENTE
    for cpu in /sys/devices/system/cpu/cpu*/cpufreq/scaling_max_freq; do
        if [ -f "$cpu" ]; then
            echo $((TARGET_MAX_FREQ * 1000)) > "$cpu" 2>/dev/null
        fi
    done
    
    # Aplicar frecuencia m√≠nima INMEDIATAMENTE
    for cpu in /sys/devices/system/cpu/cpu*/cpufreq/scaling_min_freq; do
        if [ -f "$cpu" ]; then
            echo $((TARGET_MIN_FREQ * 1000)) > "$cpu" 2>/dev/null
        fi
    done
    
    # Si hay arquitectura h√≠brida, aplicar l√≠mites espec√≠ficos INMEDIATAMENTE
    if [ "$HAS_HYBRID" = true ] && [ $E_CORES -gt 0 ]; then
        # P-cores (primeros cores)
        for i in $(seq 0 $((P_CORES - 1))); do
            if [ -f /sys/devices/system/cpu/cpu$i/cpufreq/scaling_max_freq ]; then
                echo $((P_CORE_MAX * 1000)) > /sys/devices/system/cpu/cpu$i/cpufreq/scaling_max_freq 2>/dev/null
            fi
        done
        
        # E-cores (√∫ltimos cores)
        for i in $(seq $P_CORES $((CPU_CORES - 1))); do
            if [ -f /sys/devices/system/cpu/cpu$i/cpufreq/scaling_max_freq ]; then
                echo $((E_CORE_MAX * 1000)) > /sys/devices/system/cpu/cpu$i/cpufreq/scaling_max_freq 2>/dev/null
            fi
        done
    fi
    
    echo -e "${GREEN}‚úì L√≠mites de frecuencia aplicados AHORA (temporal)${NC}"
    echo -e "${YELLOW}  Los cambios est√°n activos pero NO son persistentes${NC}"
    UNSAVED_CHANGES=true
}

apply_prochot() {
    # PROCHOT temperature offset
    # Nota: Requiere MSR y puede no estar disponible en todas las CPUs
    if [ -c /dev/cpu/0/msr ] && [ $PROCHOT_OFFSET -ne 0 ]; then
        echo -e "${YELLOW}‚ö† PROCHOT offset requiere acceso MSR directo${NC}"
        echo -e "${YELLOW}  Implementaci√≥n espec√≠fica por CPU necesaria${NC}"
    fi
    UNSAVED_CHANGES=true
}

# ============================================================================
# FUNCIONES DE GUARDADO PERSISTENTE
# ============================================================================

save_persistent_config() {
    echo ""
    echo -e "${BOLD}${YELLOW}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "${BOLD}${YELLOW}           GUARDAR CONFIGURACI√ìN PERSISTENTE${NC}"
    echo -e "${BOLD}${YELLOW}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo ""
    echo -e "${YELLOW}Esta configuraci√≥n se aplicar√° AUTOM√ÅTICAMENTE en cada arranque.${NC}"
    echo ""
    echo -e "Configuraci√≥n actual:"
    echo -e "  ${CYAN}Undervolt:${NC}"
    echo -e "    CPU: ${GREEN}${UV_CPU}${NC} mV | GPU: ${GREEN}${UV_GPU}${NC} mV | Cache: ${GREEN}${UV_CACHE}${NC} mV"
    echo -e "  ${CYAN}TDP:${NC}"
    echo -e "    PL1: ${GREEN}${PL1_CURRENT}${NC}W | PL2: ${GREEN}${PL2_CURRENT}${NC}W"
    echo -e "  ${CYAN}Frecuencias:${NC}"
    echo -e "    Min: ${GREEN}${TARGET_MIN_FREQ}${NC}MHz | Max: ${GREEN}${TARGET_MAX_FREQ}${NC}MHz"
    if [ "$HAS_HYBRID" = true ]; then
        echo -e "    P-core: ${GREEN}${P_CORE_MAX}${NC}MHz | E-core: ${GREEN}${E_CORE_MAX}${NC}MHz"
    fi
    echo ""
    echo -e "${RED}‚ö†Ô∏è  ADVERTENCIA:${NC}"
    echo -e "  Si el sistema no arranca despu√©s de guardar, necesitar√°s:"
    echo -e "  1. Arrancar en modo recovery"
    echo -e "  2. Deshabilitar el servicio: systemctl disable cpu-power-manager"
    echo ""
    echo -e "${BOLD}Para confirmar, escribe exactamente:${NC} ${GREEN}GUARDAR PERMANENTE${NC}"
    echo -e "${BOLD}Para cancelar, escribe cualquier otra cosa${NC}"
    echo ""
    read -p "Confirmaci√≥n: " confirmation
    
    if [ "$confirmation" = "GUARDAR PERMANENTE" ]; then
        # Guardar configuraci√≥n de undervolt
        cat > "$UNDERVOLT_CONF" << EOF
# CPU Power Manager - Undervolt Config
UV_CPU=$UV_CPU
UV_GPU=$UV_GPU
UV_CACHE=$UV_CACHE
UV_SA=$UV_SA
UV_IO=$UV_IO
EOF
        
        # Guardar configuraci√≥n de power
        cat > "$POWER_CONF" << EOF
# CPU Power Manager - Power Config
PL1_CURRENT=$PL1_CURRENT
PL2_CURRENT=$PL2_CURRENT
PL1_TIME=$PL1_TIME
PROCHOT_OFFSET=$PROCHOT_OFFSET
EOF
        
        # Guardar configuraci√≥n de frecuencias
        cat > "$FREQ_CONF" << EOF
# CPU Power Manager - Frequency Config
TARGET_MAX_FREQ=$TARGET_MAX_FREQ
TARGET_MIN_FREQ=$TARGET_MIN_FREQ
P_CORE_MAX=$P_CORE_MAX
E_CORE_MAX=$E_CORE_MAX
EOF
        
        # Guardar configuraci√≥n de intel-undervolt
        if command -v intel-undervolt >/dev/null 2>&1; then
            cat > /etc/intel-undervolt.conf << EOF
# Intel Undervolt Configuration - Auto-generated by CPU Power Manager
undervolt 0 'CPU' $UV_CPU
undervolt 1 'GPU' $UV_GPU
undervolt 2 'CPU Cache' $UV_CACHE
undervolt 3 'System Agent' $UV_SA
undervolt 4 'Analog I/O' $UV_IO
EOF
        fi
        
        # Crear script de inicio
        create_startup_service
        
        echo ""
        echo -e "${GREEN}‚úì‚úì‚úì CONFIGURACI√ìN GUARDADA PERMANENTEMENTE ‚úì‚úì‚úì${NC}"
        echo ""
        echo -e "  üìÅ Archivos de configuraci√≥n:"
        echo -e "     $UNDERVOLT_CONF"
        echo -e "     $POWER_CONF"
        echo -e "     $FREQ_CONF"
        echo ""
        echo -e "  üîÑ Servicio de arranque: HABILITADO"
        echo -e "     systemctl status cpu-power-manager"
        echo ""
        echo -e "  ‚úÖ Esta configuraci√≥n se aplicar√° en cada arranque"
        echo ""
        
        UNSAVED_CHANGES=false
        return 0
    else
        echo ""
        echo -e "${RED}‚úó Guardado cancelado${NC}"
        echo -e "  Los cambios actuales siguen activos pero NO son persistentes"
        echo ""
        return 1
    fi
}

create_startup_service() {
    # Crear script de aplicaci√≥n
    cat > /usr/local/bin/cpu-power-apply << 'APPLYSCRIPT'
#!/bin/bash
# CPU Power Manager - Apply on boot

CONFIG_DIR="/etc/cpu-power-manager"

# Cargar configuraciones
[ -f "$CONFIG_DIR/undervolt.conf" ] && source "$CONFIG_DIR/undervolt.conf"
[ -f "$CONFIG_DIR/power.conf" ] && source "$CONFIG_DIR/power.conf"
[ -f "$CONFIG_DIR/frequency.conf" ] && source "$CONFIG_DIR/frequency.conf"

# Aplicar undervolt
if command -v intel-undervolt >/dev/null 2>&1; then
    intel-undervolt apply 2>/dev/null
fi

# Aplicar power limits
if [ -d /sys/class/powercap/intel-rapl/intel-rapl:0/ ]; then
    [ -n "$PL1_CURRENT" ] && echo $((PL1_CURRENT * 1000000)) > /sys/class/powercap/intel-rapl/intel-rapl:0/constraint_0_power_limit_uw 2>/dev/null
    [ -n "$PL2_CURRENT" ] && echo $((PL2_CURRENT * 1000000)) > /sys/class/powercap/intel-rapl/intel-rapl:0/constraint_1_power_limit_uw 2>/dev/null
    [ -n "$PL1_TIME" ] && echo $((PL1_TIME * 1000000)) > /sys/class/powercap/intel-rapl/intel-rapl:0/constraint_0_time_window_us 2>/dev/null
fi

# Aplicar frecuencias
if [ -n "$TARGET_MAX_FREQ" ]; then
    for cpu in /sys/devices/system/cpu/cpu*/cpufreq/scaling_max_freq; do
        [ -f "$cpu" ] && echo $((TARGET_MAX_FREQ * 1000)) > "$cpu" 2>/dev/null
    done
fi

if [ -n "$TARGET_MIN_FREQ" ]; then
    for cpu in /sys/devices/system/cpu/cpu*/cpufreq/scaling_min_freq; do
        [ -f "$cpu" ] && echo $((TARGET_MIN_FREQ * 1000)) > "$cpu" 2>/dev/null
    done
fi

logger "CPU Power Manager: Configuration applied"
APPLYSCRIPT
    
    chmod +x /usr/local/bin/cpu-power-apply
    
    # Crear servicio systemd
    cat > "$STARTUP_SCRIPT" << 'SERVICEEOF'
[Unit]
Description=CPU Power Manager - Apply settings on boot
After=multi-user.target

[Service]
Type=oneshot
ExecStart=/usr/local/bin/cpu-power-apply
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
SERVICEEOF
    
    # Habilitar servicio
    systemctl daemon-reload
    systemctl enable cpu-power-manager 2>/dev/null
}

check_unsaved_changes() {
    if [ "$UNSAVED_CHANGES" = true ]; then
        echo ""
        echo -e "${BOLD}${RED}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
        echo -e "${BOLD}${RED}              ‚ö†Ô∏è  CAMBIOS NO GUARDADOS ‚ö†Ô∏è${NC}"
        echo -e "${BOLD}${RED}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
        echo ""
        echo -e "${YELLOW}Has realizado cambios que est√°n ACTIVOS AHORA pero NO persistir√°n${NC}"
        echo -e "${YELLOW}despu√©s de reiniciar.${NC}"
        echo ""
        echo -e "Opciones:"
        echo -e "  ${GREEN}1)${NC} Guardar configuraci√≥n (permanente al reiniciar)"
        echo -e "  ${YELLOW}2)${NC} Descartar cambios y salir"
        echo -e "  ${BLUE}3)${NC} Volver al men√∫ principal"
        echo ""
        read -p "Selecciona opci√≥n (1-3): " choice
        
        case $choice in
            1)
                save_persistent_config
                if [ $? -eq 0 ]; then
                    return 0
                else
                    return 1
                fi
                ;;
            2)
                echo ""
                echo -e "${YELLOW}Cambios descartados. Los valores volver√°n al arrancar.${NC}"
                return 0
                ;;
            3)
                return 1
                ;;
            *)
                return 1
                ;;
        esac
    fi
    return 0
}

# ============================================================================
# INTERFAZ DE USUARIO
# ============================================================================

show_header() {
    clear
    echo -e "${BOLD}${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${BOLD}${CYAN}‚ïë          CPU POWER MANAGER v$VERSION - ThrottleStop-like       ‚ïë${NC}"
    echo -e "${BOLD}${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
}

show_cpu_info() {
    echo -e "${BOLD}${BLUE}CPU Information:${NC}"
    echo -e "  Modelo: ${GREEN}$CPU_MODEL${NC}"
    echo -e "  Generaci√≥n: ${GREEN}$CPU_GEN${NC}"
    
    if [ "$HAS_HYBRID" = true ]; then
        echo -e "  Arquitectura: ${YELLOW}H√≠brida (P-cores + E-cores)${NC}"
        echo -e "  P-cores: ${GREEN}$P_CORES${NC} | E-cores: ${GREEN}$E_CORES${NC}"
    else
        echo -e "  Cores: ${GREEN}$CPU_CORES${NC}"
    fi
    
    echo -e "  Temperatura: ${GREEN}${CPU_TEMP}¬∞C${NC}"
    echo ""
}

show_current_status() {
    echo -e "${BOLD}${BLUE}Estado Actual:${NC}"
    echo ""
    
    # Undervolt
    echo -e "${BOLD}  Undervolt:${NC}"
    echo -e "    CPU:          ${GREEN}${UV_CPU} mV${NC}"
    echo -e "    GPU:          ${GREEN}${UV_GPU} mV${NC}"
    echo -e "    Cache:        ${GREEN}${UV_CACHE} mV${NC}"
    echo -e "    System Agent: ${GREEN}${UV_SA} mV${NC}"
    echo -e "    Analog I/O:   ${GREEN}${UV_IO} mV${NC}"
    echo ""
    
    # Power Limits
    echo -e "${BOLD}  L√≠mites de Potencia (TDP):${NC}"
    echo -e "    PL1 (Long):   ${GREEN}${PL1_CURRENT} W${NC} (${PL1_TIME}s)"
    echo -e "    PL2 (Short):  ${GREEN}${PL2_CURRENT} W${NC}"
    echo -e "    PROCHOT:      ${GREEN}${PROCHOT_OFFSET}¬∞C${NC} offset"
    echo ""
    
    # Frequency
    echo -e "${BOLD}  Frecuencias:${NC}"
    echo -e "    M√≠nima:       ${GREEN}${MIN_FREQ} MHz${NC}"
    echo -e "    M√°xima:       ${GREEN}${MAX_FREQ} MHz${NC}"
    if [ "$HAS_HYBRID" = true ]; then
        echo -e "    P-core max:   ${GREEN}${P_CORE_MAX} MHz${NC}"
        echo -e "    E-core max:   ${GREEN}${E_CORE_MAX} MHz${NC}"
    fi
    echo -e "    HW Max:       ${CYAN}${CPUINFO_MAX} MHz${NC}"
    echo ""
}

menu_undervolt() {
    while true; do
        show_header
        show_cpu_info
        
        echo -e "${BOLD}${YELLOW}‚ïê‚ïê‚ïê CONFIGURACI√ìN UNDERVOLT ‚ïê‚ïê‚ïê${NC}"
        echo ""
        echo -e "${CYAN}L√≠mites: ${UV_MIN} a ${UV_MAX} mV (seguro hasta ${UV_SAFE} mV)${NC}"
        if [ "$UNSAVED_CHANGES" = true ]; then
            echo -e "${RED}‚ö†Ô∏è  Cambios activos pero NO guardados${NC}"
        fi
        echo ""
        echo -e "  Valores actuales:"
        echo -e "    1) CPU Cores:     ${GREEN}${UV_CPU} mV${NC}"
        echo -e "    2) GPU/iGPU:      ${GREEN}${UV_GPU} mV${NC}"
        echo -e "    3) CPU Cache:     ${GREEN}${UV_CACHE} mV${NC}"
        echo -e "    4) System Agent:  ${GREEN}${UV_SA} mV${NC}"
        echo -e "    5) Analog I/O:    ${GREEN}${UV_IO} mV${NC}"
        echo ""
        echo -e "  ${YELLOW}p)${NC} Presets (valores recomendados)"
        echo -e "  ${CYAN}l)${NC} Ver l√≠mites de seguridad"
        echo -e "  ${RED}r)${NC} Reset (todo a 0)"
        echo -e "  ${BLUE}b)${NC} Volver"
        echo ""
        echo -e "${YELLOW}Los cambios se aplican INMEDIATAMENTE${NC}"
        echo ""
        read -p "Selecciona opci√≥n: " opt
        
        case $opt in
            1) 
                read -p "Nuevo valor CPU (mV, negativo para undervolt): " new_val
                if validate_undervolt "$new_val" "CPU"; then
                    UV_CPU=$new_val
                    apply_undervolt
                    read -p "Presiona Enter para continuar..."
                fi
                ;;
            2) 
                read -p "Nuevo valor GPU (mV): " new_val
                if validate_undervolt "$new_val" "GPU"; then
                    UV_GPU=$new_val
                    apply_undervolt
                    read -p "Presiona Enter para continuar..."
                fi
                ;;
            3) 
                read -p "Nuevo valor Cache (mV): " new_val
                if validate_undervolt "$new_val" "Cache"; then
                    UV_CACHE=$new_val
                    apply_undervolt
                    read -p "Presiona Enter para continuar..."
                fi
                ;;
            4) 
                read -p "Nuevo valor SA (mV): " new_val
                if validate_undervolt "$new_val" "SA"; then
                    UV_SA=$new_val
                    apply_undervolt
                    read -p "Presiona Enter para continuar..."
                fi
                ;;
            5) 
                read -p "Nuevo valor IO (mV): " new_val
                if validate_undervolt "$new_val" "IO"; then
                    UV_IO=$new_val
                    apply_undervolt
                    read -p "Presiona Enter para continuar..."
                fi
                ;;
            p|P) 
                menu_undervolt_presets
                apply_undervolt
                read -p "Presiona Enter para continuar..."
                ;;
            l|L) show_limits ;;
            r|R) 
                UV_CPU=0; UV_GPU=0; UV_CACHE=0; UV_SA=0; UV_IO=0
                apply_undervolt
                read -p "Presiona Enter para continuar..."
                ;;
            b|B) return ;;
        esac
    done
}

menu_undervolt_presets() {
    echo ""
    echo -e "${BOLD}${YELLOW}Presets de Undervolt:${NC}"
    echo ""
    echo "  1) Conservador (-50/-50/-50/-30/-30)"
    echo "  2) Moderado    (-80/-60/-80/-40/-40)"
    echo "  3) Agresivo    (-100/-80/-100/-50/-50)"
    echo "  4) M√°ximo      (-125/-100/-125/-60/-60)"
    echo ""
    read -p "Selecciona preset (1-4): " preset
    
    case $preset in
        1) UV_CPU=-50; UV_GPU=-50; UV_CACHE=-50; UV_SA=-30; UV_IO=-30 ;;
        2) UV_CPU=-80; UV_GPU=-60; UV_CACHE=-80; UV_SA=-40; UV_IO=-40 ;;
        3) UV_CPU=-100; UV_GPU=-80; UV_CACHE=-100; UV_SA=-50; UV_IO=-50 ;;
        4) UV_CPU=-125; UV_GPU=-100; UV_CACHE=-125; UV_SA=-60; UV_IO=-60 ;;
    esac
}

menu_power() {
    while true; do
        show_header
        show_cpu_info
        
        echo -e "${BOLD}${YELLOW}‚ïê‚ïê‚ïê L√çMITES DE POTENCIA (TDP) ‚ïê‚ïê‚ïê${NC}"
        echo ""
        echo -e "${CYAN}TDP: ${PL_MIN}-${PL_MAX}W (seguro: ${PL_SAFE_MIN}-${PL_SAFE_MAX}W) | Time: ${TIME_MIN}-${TIME_MAX}s | PROCHOT: ${PROCHOT_MIN} a ${PROCHOT_MAX}¬∞C${NC}"
        if [ "$UNSAVED_CHANGES" = true ]; then
            echo -e "${RED}‚ö†Ô∏è  Cambios activos pero NO guardados${NC}"
        fi
        echo ""
        echo -e "  Valores actuales:"
        echo -e "    1) PL1 (Long):    ${GREEN}${PL1_CURRENT} W${NC}"
        echo -e "    2) PL2 (Short):   ${GREEN}${PL2_CURRENT} W${NC}"
        echo -e "    3) PL1 Time:      ${GREEN}${PL1_TIME} s${NC}"
        echo -e "    4) PROCHOT Offset: ${GREEN}${PROCHOT_OFFSET}¬∞C${NC}"
        echo ""
        echo -e "  ${YELLOW}p)${NC} Presets (perfiles comunes)"
        echo -e "  ${CYAN}l)${NC} Ver l√≠mites de seguridad"
        echo -e "  ${BLUE}b)${NC} Volver"
        echo ""
        echo -e "${YELLOW}Los cambios se aplican INMEDIATAMENTE${NC}"
        echo ""
        read -p "Selecciona opci√≥n: " opt
        
        case $opt in
            1) 
                read -p "Nuevo PL1 (W): " new_val
                if validate_power_limit "$new_val" "PL1"; then
                    PL1_CURRENT=$new_val
                    apply_power_limits
                    read -p "Presiona Enter..."
                fi
                ;;
            2) 
                read -p "Nuevo PL2 (W): " new_val
                if validate_power_limit "$new_val" "PL2"; then
                    PL2_CURRENT=$new_val
                    apply_power_limits
                    read -p "Presiona Enter..."
                fi
                ;;
            3) 
                read -p "PL1 Time (s): " new_val
                if validate_time_window "$new_val"; then
                    PL1_TIME=$new_val
                    apply_power_limits
                    read -p "Presiona Enter..."
                fi
                ;;
            4) 
                read -p "PROCHOT Offset (¬∞C): " new_val
                if validate_prochot "$new_val"; then
                    PROCHOT_OFFSET=$new_val
                    apply_prochot
                    read -p "Presiona Enter..."
                fi
                ;;
            p|P) 
                menu_power_presets
                apply_power_limits
                read -p "Presiona Enter..."
                ;;
            l|L) show_limits ;;
            b|B) return ;;
        esac
    done
}

menu_power_presets() {
    echo ""
    echo -e "${BOLD}${YELLOW}Presets de TDP:${NC}"
    echo ""
    echo "  1) M√°xima bater√≠a  (PL1: 15W, PL2: 20W)"
    echo "  2) Balanceado      (PL1: 25W, PL2: 35W)"
    echo "  3) Rendimiento     (PL1: 35W, PL2: 45W)"
    echo "  4) M√°ximo          (PL1: 45W, PL2: 60W)"
    echo ""
    read -p "Selecciona preset (1-4): " preset
    
    case $preset in
        1) PL1_CURRENT=15; PL2_CURRENT=20; PL1_TIME=28 ;;
        2) PL1_CURRENT=25; PL2_CURRENT=35; PL1_TIME=28 ;;
        3) PL1_CURRENT=35; PL2_CURRENT=45; PL1_TIME=28 ;;
        4) PL1_CURRENT=45; PL2_CURRENT=60; PL1_TIME=28 ;;
    esac
}

menu_frequency() {
    while true; do
        show_header
        show_cpu_info
        
        echo -e "${BOLD}${YELLOW}‚ïê‚ïê‚ïê L√çMITES DE FRECUENCIA ‚ïê‚ïê‚ïê${NC}"
        echo ""
        echo -e "${CYAN}Rango permitido: ${FREQ_MIN}-${FREQ_MAX} MHz | HW M√°ximo: ${CPUINFO_MAX} MHz${NC}"
        if [ "$UNSAVED_CHANGES" = true ]; then
            echo -e "${RED}‚ö†Ô∏è  Cambios activos pero NO guardados${NC}"
        fi
        echo ""
        echo -e "  Valores actuales:"
        echo -e "    1) Frecuencia m√≠nima:  ${GREEN}${TARGET_MIN_FREQ} MHz${NC}"
        echo -e "    2) Frecuencia m√°xima:  ${GREEN}${TARGET_MAX_FREQ} MHz${NC}"
        
        if [ "$HAS_HYBRID" = true ]; then
            echo -e "    3) P-core m√°xima:      ${GREEN}${P_CORE_MAX} MHz${NC}"
            echo -e "    4) E-core m√°xima:      ${GREEN}${E_CORE_MAX} MHz${NC}"
        fi
        
        echo ""
        echo -e "  Hardware m√°ximo: ${CYAN}${CPUINFO_MAX} MHz${NC}"
        echo ""
        echo -e "  ${CYAN}l)${NC} Ver l√≠mites de seguridad"
        echo -e "  ${RED}r)${NC} Reset a valores de hardware"
        echo -e "  ${BLUE}b)${NC} Volver"
        echo ""
        echo -e "${YELLOW}Los cambios se aplican INMEDIATAMENTE${NC}"
        echo ""
        read -p "Selecciona opci√≥n: " opt
        
        case $opt in
            1) 
                read -p "Nueva frecuencia m√≠nima (MHz): " new_val
                if validate_frequency "$new_val" "min"; then
                    if validate_frequency_range "$new_val" "$TARGET_MAX_FREQ"; then
                        TARGET_MIN_FREQ=$new_val
                        apply_frequency_limits
                        read -p "Presiona Enter..."
                    fi
                fi
                ;;
            2) 
                read -p "Nueva frecuencia m√°xima (MHz): " new_val
                result=$(validate_frequency "$new_val" "max")
                ret=$?
                if [ $ret -eq 2 ]; then
                    TARGET_MAX_FREQ=$CPUINFO_MAX
                    apply_frequency_limits
                    read -p "Presiona Enter..."
                elif [ $ret -eq 0 ]; then
                    if validate_frequency_range "$TARGET_MIN_FREQ" "$new_val"; then
                        TARGET_MAX_FREQ=$new_val
                        apply_frequency_limits
                        read -p "Presiona Enter..."
                    fi
                fi
                ;;
            3) 
                if [ "$HAS_HYBRID" = true ]; then
                    read -p "Nueva P-core m√°xima (MHz): " new_val
                    result=$(validate_frequency "$new_val" "max")
                    ret=$?
                    if [ $ret -eq 2 ]; then
                        P_CORE_MAX=$CPUINFO_MAX
                    elif [ $ret -eq 0 ]; then
                        P_CORE_MAX=$new_val
                    fi
                    apply_frequency_limits
                    read -p "Presiona Enter..."
                fi
                ;;
            4)
                if [ "$HAS_HYBRID" = true ]; then
                    read -p "Nueva E-core m√°xima (MHz): " new_val
                    result=$(validate_frequency "$new_val" "max")
                    ret=$?
                    if [ $ret -eq 2 ]; then
                        E_CORE_MAX=$CPUINFO_MAX
                    elif [ $ret -eq 0 ]; then
                        E_CORE_MAX=$new_val
                    fi
                    apply_frequency_limits
                    read -p "Presiona Enter..."
                fi
                ;;
            l|L) show_limits ;;
            r|R) 
                read_current_freq
                TARGET_MAX_FREQ=$CPUINFO_MAX
                P_CORE_MAX=$CPUINFO_MAX
                E_CORE_MAX=$CPUINFO_MAX
                apply_frequency_limits
                echo -e "${GREEN}‚úì Frecuencias reseteadas a valores de hardware${NC}"
                read -p "Presiona Enter..."
                ;;
            b|B) return ;;
        esac
    done
}

menu_profiles() {
    while true; do
        show_header
        
        echo -e "${BOLD}${YELLOW}‚ïê‚ïê‚ïê PERFILES COMPLETOS ‚ïê‚ïê‚ïê${NC}"
        echo ""
        echo "  1) M√°xima Bater√≠a"
        echo "     - Undervolt moderado (-80mV)"
        echo "     - TDP bajo (15W/20W)"
        echo "     - Frecuencia reducida"
        echo ""
        echo "  2) Balanceado"
        echo "     - Undervolt conservador (-50mV)"
        echo "     - TDP medio (25W/35W)"
        echo "     - Frecuencia normal"
        echo ""
        echo "  3) Rendimiento"
        echo "     - Undervolt agresivo (-100mV)"
        echo "     - TDP alto (35W/45W)"
        echo "     - Frecuencia m√°xima"
        echo ""
        echo "  4) Gaming/M√°ximo"
        echo "     - Sin undervolt (0mV)"
        echo "     - TDP m√°ximo (45W/60W)"
        echo "     - Frecuencia sin l√≠mite"
        echo ""
        echo -e "  ${BLUE}b)${NC} Volver"
        echo ""
        read -p "Selecciona perfil (1-4): " profile
        
        case $profile in
            1)
                # M√°xima Bater√≠a
                UV_CPU=-80; UV_GPU=-60; UV_CACHE=-80; UV_SA=-40; UV_IO=-40
                PL1_CURRENT=15; PL2_CURRENT=20; PL1_TIME=28
                TARGET_MAX_FREQ=$((CPUINFO_MAX * 70 / 100))
                TARGET_MIN_FREQ=800
                P_CORE_MAX=$TARGET_MAX_FREQ
                E_CORE_MAX=$((TARGET_MAX_FREQ * 80 / 100))
                
                apply_undervolt
                apply_power_limits
                apply_frequency_limits
                
                echo -e "${GREEN}‚úì Perfil 'M√°xima Bater√≠a' aplicado${NC}"
                read -p "Presiona Enter..."
                ;;
            2)
                # Balanceado
                UV_CPU=-50; UV_GPU=-50; UV_CACHE=-50; UV_SA=-30; UV_IO=-30
                PL1_CURRENT=25; PL2_CURRENT=35; PL1_TIME=28
                TARGET_MAX_FREQ=$CPUINFO_MAX
                TARGET_MIN_FREQ=800
                P_CORE_MAX=$CPUINFO_MAX
                E_CORE_MAX=$((CPUINFO_MAX * 85 / 100))
                
                apply_undervolt
                apply_power_limits
                apply_frequency_limits
                
                echo -e "${GREEN}‚úì Perfil 'Balanceado' aplicado${NC}"
                read -p "Presiona Enter..."
                ;;
            3)
                # Rendimiento
                UV_CPU=-100; UV_GPU=-80; UV_CACHE=-100; UV_SA=-50; UV_IO=-50
                PL1_CURRENT=35; PL2_CURRENT=45; PL1_TIME=28
                TARGET_MAX_FREQ=$CPUINFO_MAX
                TARGET_MIN_FREQ=1200
                P_CORE_MAX=$CPUINFO_MAX
                E_CORE_MAX=$CPUINFO_MAX
                
                apply_undervolt
                apply_power_limits
                apply_frequency_limits
                
                echo -e "${GREEN}‚úì Perfil 'Rendimiento' aplicado${NC}"
                read -p "Presiona Enter..."
                ;;
            4)
                # Gaming/M√°ximo
                UV_CPU=0; UV_GPU=0; UV_CACHE=0; UV_SA=0; UV_IO=0
                PL1_CURRENT=45; PL2_CURRENT=60; PL1_TIME=28
                TARGET_MAX_FREQ=$CPUINFO_MAX
                TARGET_MIN_FREQ=1200
                P_CORE_MAX=$CPUINFO_MAX
                E_CORE_MAX=$CPUINFO_MAX
                
                apply_undervolt
                apply_power_limits
                apply_frequency_limits
                
                echo -e "${GREEN}‚úì Perfil 'Gaming/M√°ximo' aplicado${NC}"
                read -p "Presiona Enter..."
                ;;
            b|B) return ;;
        esac
    done
}

menu_monitoring() {
    while true; do
        show_header
        read_current_temps
        
        echo -e "${BOLD}${YELLOW}‚ïê‚ïê‚ïê MONITOREO EN TIEMPO REAL ‚ïê‚ïê‚ïê${NC}"
        echo ""
        
        # Temperaturas
        echo -e "${BOLD}Temperaturas:${NC}"
        if command -v sensors >/dev/null 2>&1; then
            sensors | grep -E "Package id|Core [0-9]|fan" | head -10
        else
            echo "  lm-sensors no instalado"
        fi
        echo ""
        
        # Frecuencias actuales
        echo -e "${BOLD}Frecuencias actuales:${NC}"
        for i in 0 1 2 3; do
            if [ -f /sys/devices/system/cpu/cpu$i/cpufreq/scaling_cur_freq ]; then
                freq=$(cat /sys/devices/system/cpu/cpu$i/cpufreq/scaling_cur_freq)
                freq=$((freq / 1000))
                echo "  Core $i: ${freq} MHz"
            fi
        done
        echo ""
        
        # Potencia
        if [ -f /sys/class/powercap/intel-rapl/intel-rapl:0/energy_uj ]; then
            power_uj=$(cat /sys/class/powercap/intel-rapl/intel-rapl:0/energy_uj)
            echo -e "${BOLD}Energ√≠a consumida:${NC} $((power_uj / 1000000)) mJ"
        fi
        echo ""
        
        echo -e "  ${BLUE}r)${NC} Refrescar"
        echo -e "  ${BLUE}b)${NC} Volver"
        echo ""
        read -t 5 -p "Opci√≥n (auto-refresh en 5s): " opt
        
        case $opt in
            b|B) return ;;
            *) continue ;;
        esac
    done
}

main_menu() {
    while true; do
        # Leer estado actual
        read_current_undervolt
        read_current_power
        read_current_freq
        read_current_temps
        
        show_header
        show_cpu_info
        show_current_status
        
        echo -e "${BOLD}${CYAN}‚ïê‚ïê‚ïê MEN√ö PRINCIPAL ‚ïê‚ïê‚ïê${NC}"
        echo ""
        
        # Mostrar advertencia si hay cambios sin guardar
        if [ "$UNSAVED_CHANGES" = true ]; then
            echo -e "  ${RED}‚ö†Ô∏è  HAY CAMBIOS NO GUARDADOS (temporales)${NC}"
            echo ""
        fi
        
        echo -e "  ${GREEN}1)${NC} Undervolt (CPU/GPU/Cache/SA/IO)"
        echo -e "  ${GREEN}2)${NC} L√≠mites de Potencia (TDP - PL1/PL2/PROCHOT)"
        echo -e "  ${GREEN}3)${NC} L√≠mites de Frecuencia (P-cores/E-cores)"
        echo -e "  ${YELLOW}4)${NC} Perfiles Completos (preconfigurados)"
        echo -e "  ${BLUE}5)${NC} Monitoreo en Tiempo Real"
        echo ""
        echo -e "  ${CYAN}i)${NC} Ver l√≠mites de seguridad"
        echo -e "  ${GREEN}s)${NC} Guardar configuraci√≥n permanente"
        echo -e "  ${CYAN}l)${NC} Cargar configuraci√≥n guardada"
        echo -e "  ${RED}q)${NC} Salir"
        echo ""
        read -p "Selecciona opci√≥n: " option
        
        case $option in
            1) menu_undervolt ;;
            2) menu_power ;;
            3) menu_frequency ;;
            4) menu_profiles ;;
            5) menu_monitoring ;;
            i|I) show_limits ;;
            s|S)
                save_persistent_config
                read -p "Presiona Enter..."
                ;;
            l|L)
                read_current_undervolt
                read_current_power
                read_current_freq
                echo ""
                echo "Aplicando configuraci√≥n guardada..."
                apply_undervolt
                apply_power_limits
                apply_frequency_limits
                echo ""
                echo -e "${GREEN}‚úì Configuraci√≥n cargada y aplicada (temporal)${NC}"
                echo -e "${YELLOW}  Para hacerla permanente, usa la opci√≥n 's'${NC}"
                read -p "Presiona Enter..."
                ;;
            q|Q) 
                if check_unsaved_changes; then
                    echo -e "${GREEN}Saliendo...${NC}"
                    exit 0
                fi
                # Si retorna 1, volver al men√∫
                ;;
        esac
    done
}

# ============================================================================
# INICIO DEL PROGRAMA
# ============================================================================

# Verificar dependencias
if ! command -v intel-undervolt >/dev/null 2>&1; then
    echo -e "${YELLOW}‚ö† Advertencia: intel-undervolt no est√° instalado${NC}"
    echo "  El undervolt no estar√° disponible"
fi

# Detectar hardware
detect_cpu
detect_cores

# Iniciar men√∫ principal
main_menu
